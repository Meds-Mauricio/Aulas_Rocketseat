"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _typeof=require("@babel/runtime/helpers/typeof");Object.defineProperty(exports,"__esModule",{value:true});exports["default"]=void 0;var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _react=_interopRequireWildcard(require("react"));var _styles=require("@material-ui/core/styles");var _core=require("@cvccorp-components/core");var _propTypes=_interopRequireDefault(require("prop-types"));var _lodash=require("lodash");var _FilterRange=_interopRequireDefault(require("./_FilterRange"));var _FilterOption=_interopRequireDefault(require("./_FilterOption"));var _FilterGrid=_interopRequireDefault(require("./_FilterGrid"));var _FilterText=_interopRequireDefault(require("./_FilterText"));var _FilterMore=_interopRequireDefault(require("./_FilterMore"));var _styles2=require("./styles");function _getRequireWildcardCache(nodeInterop){if(typeof WeakMap!=="function")return null;var cacheBabelInterop=new WeakMap;var cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function _getRequireWildcardCache(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule){return obj}if(obj===null||_typeof(obj)!=="object"&&typeof obj!=="function"){return{"default":obj}}var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj)){return cache.get(obj)}var newObj={};var hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj){if(key!=="default"&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;if(desc&&(desc.get||desc.set)){Object.defineProperty(newObj,key,desc)}else{newObj[key]=obj[key]}}}newObj["default"]=obj;if(cache){cache.set(obj,newObj)}return newObj}function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly){symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable})}keys.push.apply(keys,symbols)}return keys}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){(0,_defineProperty2["default"])(target,key,source[key])})}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source))}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))})}}return target}var FilterEngine=function FilterEngine(props){var filters=props.filters,dataSource=props.dataSource,onFiltred=props.onFiltred,_onApply=props.onApply,classes=props.classes,activeFilterMore=props.activeFilterMore,height=props.height;var _useState=(0,_react.useState)([]),_useState2=(0,_slicedToArray2["default"])(_useState,2),items=_useState2[0],setItems=_useState2[1];(0,_react.useEffect)(function(){var fts=(0,_toConsumableArray2["default"])(filters);fts=fts.map(function(ft){Object.assign(ft,{open:false});if(ft.type==="range"){Object.assign(ft,{filterTitle:""});Object.assign(ft,{rangeTitleValues:{min:ft.min,max:ft.max}});Object.assign(ft,{rangeValue:{min:ft.min,max:ft.max}});Object.assign(ft,{rangeTextValues:{min:ft.min,max:ft.max}})}if(ft.type==="filterMore"){Object.assign(ft,{value:[""]});Object.assign(ft,{active:false})}return ft});setItems((0,_toConsumableArray2["default"])(fts))},[]);(0,_react.useEffect)(function(){var fts=items;if(fts.length){fts=fts.map(function(ft){if(ft.type==="filterMore"){return _objectSpread(_objectSpread({},ft),{},{isOpen:filters.find(function(filter){return filter.type==="filterMore"}).isOpen})}return ft});setItems((0,_toConsumableArray2["default"])(fts))}},[filters]);// FILTER_GRID
var filterGrid=function filterGrid(item,values){var options=item.forFilter?item.forFilter:item.options;var optionStart=false;var newValues=[];options=options.filter(function(o){return o.checked});if(options.length===0)return values;options.forEach(function(option){var dsOptions=[];if(item.operator==="or")dsOptions=values;if(item.operator==="and")dsOptions=!optionStart?values:[newValues];var opts=(0,_lodash.filter)(dsOptions,function(el){if(typeof item.field==="string"){return(0,_lodash.get)(el,item.field,{})===option.code}return item.field(el,option)});if(!optionStart)optionStart=true;if(item.operator==="or")opts.forEach(function(opt){return newValues.push(opt)});if(item.operator==="and")newValues=opts});return newValues};// FILTER_OPTIONS
var filterOptions=function filterOptions(item,values){var options=item.forFilter?item.forFilter:item.options;var optionStart=false;var newValues=[];options=options.filter(function(o){return o.checked});if(options.length===0)return values;options.forEach(function(option){var dsOptions=[];if(item.operator==="or")dsOptions=values;if(item.operator==="and")dsOptions=!optionStart?values:[newValues];var opts=(0,_lodash.filter)(dsOptions,function(el){if(typeof item.field==="string"){return(0,_lodash.get)(el,item.field,{})===option.value}return item.field(el,option)});if(!optionStart)optionStart=true;if(item.operator==="or")opts.forEach(function(opt){return newValues.push(opt)});if(item.operator==="and")newValues=opts});return newValues};// FILTER_RANGE
var filterRange=function filterRange(item,values){var value=item.rangeValue?item.rangeValue:{min:item.min,max:item.max};var range=(0,_lodash.filter)(values,function(el){var cond=(0,_lodash.get)(el,item.field,{});return cond>=value.min&&cond<=value.max});return range};// FILTER_TEXT
var filterText=function filterText(item,values){var value=item.forFilter?item.forFilter:item.value;if(!value)return values;var texts=(0,_lodash.filter)(values,function(el){var cond=(0,_lodash.get)(el,item.field,{});return cond.toUpperCase().includes(value.toUpperCase())});return texts};// ON_APLLY
var onClientApply=function onClientApply(value,ft,index){var values=(0,_toConsumableArray2["default"])(dataSource);var filterSelected=items[index];if(ft.type==="filterMore"&&value.length){value.forEach(function(obj){if(obj.type==="range")values=(0,_toConsumableArray2["default"])(filterRange(obj,values));if(obj.type==="options")values=(0,_toConsumableArray2["default"])(filterOptions(obj,values));if(obj.type==="grid")values=(0,_toConsumableArray2["default"])(filterGrid(obj,values));if(obj.type==="text")values=(0,_toConsumableArray2["default"])(filterText(obj,values))})}if(ft.type==="range")filterSelected.forFilter={min:value.min,max:value.max};if(ft.type==="options"||ft.type==="grid"||ft.type==="text")filterSelected.forFilter=value;items.forEach(function(obj){if(obj.type==="range")values=(0,_toConsumableArray2["default"])(filterRange(obj,values));if(obj.type==="options")values=(0,_toConsumableArray2["default"])(filterOptions(obj,values));if(obj.type==="grid")values=(0,_toConsumableArray2["default"])(filterGrid(obj,values));if(obj.type==="text")values=(0,_toConsumableArray2["default"])(filterText(obj,values))});if(onFiltred)onFiltred(values)};return items.map(function(item,index){var type=item.type;var _filter=null;if(type===_core.Filters.RANGE){_filter=/*#__PURE__*/_react["default"].createElement(_FilterRange["default"],{onApply:function onApply(_items){var value=_items[index].rangeTextValues;if(dataSource)onClientApply(value,item,index);else _onApply({value:value,item:_items[index],index:index})},index:index,filters:items,filter:item,className:classes.item,height:height})}if(type===_core.Filters.OPTIONS){_filter=/*#__PURE__*/_react["default"].createElement(_FilterOption["default"],{onApply:function onApply(_items){var value=_items[index].options;if(dataSource)onClientApply(value,item,index);else if(_onApply)_onApply({value:value,item:item,index:index})},index:index,filters:items,filter:item,className:classes.item,height:height})}if(type===_core.Filters.GRID){_filter=/*#__PURE__*/_react["default"].createElement(_FilterGrid["default"],{onApply:function onApply(_items){var value=_items[index].options;if(dataSource)onClientApply(value,item,index);else if(_onApply)_onApply({value:value,item:item,index:index})},index:index,filters:items,filter:item,filterObj:item,className:classes.item,height:height})}if(type===_core.Filters.TEXT){_filter=/*#__PURE__*/_react["default"].createElement(_FilterText["default"],{onApply:function onApply(_items){var value=_items[index].value;if(dataSource)onClientApply(value,item,index);else if(_onApply)_onApply({value:value,item:_items[index],index:index})},index:index,filters:items,filter:item,className:classes.item,height:height})}if(type===_core.Filters.MORE){return/*#__PURE__*/_react["default"].createElement(_FilterMore["default"],{onApply:function onApply(values){var filterActives=values.filter(function(f){return f.isActive});var filterTitle=filterActives.length===1?[1]:filterActives.length===0?"":filterActives;var value=filterTitle;var isActive=item.isMobile||filterTitle===""?false:filterActives.length>0;var _item=_objectSpread(_objectSpread({},item),{},{filterTitle:filterTitle,value:value,isActive:isActive,filters:(0,_toConsumableArray2["default"])(values)});var newItems=items;newItems[index]=_item;setItems((0,_toConsumableArray2["default"])(newItems));if(dataSource)onClientApply(values,item,index);else if(_onApply)_onApply({value:value,item:_item,index:index})},item:item,classes:classes,onActives:function onActives(value){return activeFilterMore(value)},height:height})}return _filter})};FilterEngine.defaultProps={activeFilterMore:function activeFilterMore(){}};FilterEngine.propTypes={activeFilterMore:_propTypes["default"].func};var _default=(0,_styles.withStyles)(_styles2.styles,{withTheme:true})(FilterEngine);exports["default"]=_default;
//# sourceMappingURL=FilterEngine.js.map